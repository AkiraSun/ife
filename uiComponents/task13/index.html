<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"> 
    <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>仿豆瓣音乐播放器</title>
    <link rel="stylesheet" href="./lib/css/main.css">
    <link rel="stylesheet" type="text/css" href="./lib/css/font-awesome.min.css">
</head>
<body>
    <div class="container">
        <div class="music">
            <div class="music__player">
                <h2 class="music__title">${music.songname}</h2>
                <p class="music__singer">${singer}</p>
                <audio class="player__source">
                    Your browser does not support the <code>audio</code> element.
                    <source src="${music.audiourl}">
                </audio>
                <span class="music__currenttime">00:00/00:00</span>
                <i class="fa fa-volume-up music__volumeicon" aria-hidden="true"></i>
                <div class="music__volume"><span class="music__volumebar"></span></div>
                <div class="player__progress"><span class="player__progressbar"></span></div>
                <span class="player__play"><i class="fa fa-play" aria-hidden="true"></i></span>
                <span class="player__faster"><i class="fa fa-forward" aria-hidden="true"></i></span>
                <span class="player__next"><i class="fa fa-step-forward" aria-hidden="true"></i></span>
                <span class="player__style"><i class="fa fa-random" aria-hidden="true"></i></span>
            </div>
            <div class="music__album">
                <img class="music__img" src="https://y.gtimg.cn/music/photo_new/T002R300x300M000${music.albummid}.jpg?max_age=2592000">
            </div>
        </div>
        <ul class="musics"></ul>
    </div>
    <script type="text/javascript" src="./lib/jquery.min.js"></script>
    <script type="text/javascript">
        function init () {
            // 初始化音乐列表
            searchMusic('河图')
                .then(res => {
                    // 渲染搜索结果列表
                    renderResult(res)
                    // 默认显示第一首
                    let number = 0
                    const title = document.querySelector('.music__title')
                    const singerEl = document.querySelector('.music__singer')
                    const time = document.querySelector('.music__currenttime')
                    // 初始化播放器控制器
                    const player = document.querySelector('.player__source')
                    const album = document.querySelector('.music__img')
                    const volumebar = document.querySelector('.music__volumebar')
                    render(res[number], title, singerEl, time, player, album, volumebar)
                    // console.dir(player)
                    // 播放暂停按钮
                    let startBtn = document.querySelector('.player__play')
                    startBtn.onclick = function () {
                        // 如果当前是暂停
                        if (player.paused) {
                            play(startBtn, player, 'play')
                            return
                        }
                        play(startBtn, player, 'pause')
                    }
                    // 总时长
                    let duration = 0
                    player.addEventListener('canplay', function (e) {
                        duration = e.target.duration
                    })
                    // 进度控制
                    const currentTime = document.querySelector('.music__currenttime')
                    const progressBar = document.querySelector('.player__progressbar')
                    // player.addEventListener('timeupdate', function (e) {
                    //     let current = e.target.currentTime
                    //     currentTime.innerHTML = formatSeconds(current) + '/' + formatSeconds(duration)
                    //     // 计算播放百分比
                    //     // console.log(typeof current, typeof duration, current, duration, current / duration)
                    //     let per = current / duration * 100 + '%'
                    //     // console.log(per)
                    //     progressBar.style.right = `calc(100% - ${per})`
                    // })
                    setInterval(() => {
                        if (player.paused) {
                            return
                        }
                        let current = player.currentTime
                        currentTime.innerHTML = formatSeconds(current) + '/' + formatSeconds(duration)
                        // 计算播放百分比
                        // console.log(typeof current, typeof duration, current, duration, current / duration)
                        let per = current / duration * 100 + '%'
                        // console.log(per)
                        progressBar.style.right = `calc(100% - ${per})`
                    })
                    const playerStyleEl = document.querySelector('.player__style')
                    // 播放方式， 默认为 1，顺序播放
                    let playStyle = 1
                    playerStyleEl.onclick = function () {
                        if (playStyle === 0) {
                            playStyle = 1
                            playerStyleEl.querySelector('.fa-refresh').className = 'fa fa-random'
                        } else {
                            playStyle = 0
                            playerStyleEl.querySelector('.fa-random').className = 'fa fa-refresh'
                        }
                    }
                    // 监听播放结束
                    player.addEventListener('ended', (e) => {
                        // 如果是顺序播放
                        if (playStyle === 1) {
                            // 播放下一首
                            number += 1
                            if (number > res.length) {
                                number = 0
                            }
                            next(res, number, title, singerEl, time, player, album, startBtn, volumebar)
                            return
                        }
                        // 如果是循环播放
                        player.currentTime = 0
                        player.play()
                        
                    })
                    // 快进
                    document.querySelector('.player__faster').onclick = function () {
                        player.currentTime += 5
                    }
                    // 音频控制
                    document.querySelector('.music__volume').onclick = function (e) {
                        // 将点击时的位置除以总长度，得到大概百分比
                        let width = e.target.clientWidth
                        const volume = (e.layerX / width).toFixed(1)
                        player.volume = volume
                        volumebar.style.width = volume * 100 + '%'
                    }
                    // 播放下一首
                    document.querySelector('.player__next').onclick = function () {
                        number += 1
                        if (number > res.length) {
                            number = 0
                        }
                        next(res, number, title, singerEl, time, player, album, startBtn, volumebar)
                    }
                })
                .catch(err => {
                    alert(err)
                })
        }
        /* 使用 qq 音乐接口搜索音乐列表
         * @param <String> query
         * @return <Promise>
         */
        function searchMusic (query, page=1) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: `https://c.y.qq.com/soso/fcgi-bin/client_search_cp?ct=24&qqmusic_ver=1298&remoteplace=sizer.yqq.song_next&searchid=151342943803015700&t=0&aggr=1&cr=1&catZhida=1&lossless=0&flag_qc=0&p=${page}&n=20&w=${query}&g_tk=755250217&loginUin=184009428&hostUin=0&format=jsonp&inCharset=utf8&outCharset=utf-8&notice=0&platform=yqq&needNewCode=0`,
                    type: 'GET',
                    dataType: 'jsonp',
                    jsonp: 'callback',
                    jsonpCallback: 'callback',
                    success (res) {
                        let list = res.data.song.list.map(music => {
                            return Object.assign(music, {
                                audiourl: `http://ws.stream.qqmusic.qq.com/${music.songid}.m4a?fromtag=46`
                            })
                        })
                        resolve(list)
                    },
                    error (err) {
                        reject(err)
                    }
                })
            })
        }
        /* 根据 json 渲染播放器
         * @param <Object> music
         */
        function render (music, title, singerEl, time, player, album, volumebar) {
            const singer = music.singer.map(singer => {
                return singer.name
            }).join(', ')

            // 拿到对应的节点更新值
            // const title = document.querySelector('.music__title')
            title.innerText = music.songname
            // const singerEl = document.querySelector('.music__singer')
            singerEl.innerText = singer
            // const time = document.querySelector('.music__currenttime')
            time.innerText = '00:00/00:00'
            volumebar.style.width = player.volume * 100 + '%'
            // const player = document.querySelector('.player__source')
            player.src = music.audiourl
            // const album = document.querySelector('.music__img')
            album.src = `https://y.gtimg.cn/music/photo_new/T002R300x300M000${music.albummid}.jpg?max_age=2592000`
            // let innerHtml = `<div class="music__player"><h2 class="music__title">${music.songname}</h2>
            // <p class="music__singer">${singer}</p>
            // <audio class="player__source">
            //     Your browser does not support the <code>audio</code> element.
            //     <source src="${music.audiourl}">
            // </audio><span class="music__currenttime"></span><i class="fa fa-volume-up music__volumeicon" aria-hidden="true"></i><div class="music__volume"><span class="music__volumebar"></span></div><div class="player__progress"><span class="player__progressbar"></span></div><span class="player__play"><i class="fa fa-play" aria-hidden="true"></i></span><span class="player__faster"><i class="fa fa-fast-forward" aria-hidden="true"></i></span></div><div class="music__album"><img class="music__img" src=""></div>`
            // document.querySelector('.music').innerHTML = innerHtml
        }
        /* 渲染搜索结果列表
         * @param <Array> ary
         */
        function renderResult (ary) {
            let container = document.createDocumentFragment()
            ary.forEach(music => {
                let li = document.createElement('li')
                li.className = 'musics__item'
                li.innerHTML = `<p>${music.songname}</p>`
                container.appendChild(li)
            })
            document.querySelector('.musics').appendChild(container)
        }
        /* 将秒数转换为时分秒
         * @param <Number>
         * @return <String>
         */
        function formatSeconds (value) {
            let second = parseInt(value)
            let hour = 0
            let minute = 0

            if (second >= 60) {
                minute = parseInt(second / 60)
                second = parseInt(second % 60)

                if (minute >= 60) {
                    hour = parseInt(minute / 60)
                    minute = parseInt(minute % 60)
                }
            }

            let result = second < 10 ? `0${second}` : second
            if (minute > 0) {
                result = (minute < 10 ? `0${minute}` : minute) + ':' + result
            } else {
                result = `00:${result}`
            }
            if (hour > 0) {
                result = (hour < 10 ? `0${hour}` : hour) + ':' + result
            }

            return result
        }
        /* 播放或者暂停音乐
         * @param <Element> btn
         * @param <Element> player
         * @param <String> type <play | pause>
         */
        function play (btn, player, type) {
            if (type === 'play') {
                player.play()
                // 并将图片更换为暂停
                btn.querySelector('.fa').className = 'fa fa-pause'
            } else if (type === 'pause') {
                player.pause()
                btn.querySelector('.fa').className = 'fa fa-play'
            }
        }
        /* 播放下一首
         */
        function next (list, current, title, singerEl, time, player, album, btn, volumebar) {
            render(list[current], title, singerEl, time, player, album, volumebar)
            play(btn, player, 'play')
        }

        $(document).ready(function () {
            init()
        })
    </script>
</body>
</html>