<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"> 
    <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>仿豆瓣音乐播放器</title>
    <link rel="stylesheet" type="text/css" href="./lib/font-awesome-4.7.0/css/font-awesome.min.css">
    <style type="text/css">
        * {
            box-sizing: border-box;
        }
        body {
            background-color: rgba(250, 250, 250, 0.933333);
        }
        body, ul, div, p, h1, h2, h3 {
            margin: 0;
            padding: 0;
        }
        li {
            list-style: none;
        }
        .music {
            width: 800px;
            margin: 0 auto;
            padding: 20px 0 50px 0;
            overflow: hidden;
        }
        .music__title {
            font-weight: normal;
        }
        .music__singer {
            margin: 8px 0 10px 0;
        }
        .music__currenttime {
            display: inline-block;
            margin-right: 10px;
            font-size: 12px;
            color: #ccc;
        }
        .music__volumnicon {
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
            font-size: 14px;
            color: #666;
        }
        .music__volumn {
            position: relative;
            display: inline-block;
            vertical-align: middle;
            width: 100px;
            height: 2px;
            border-radius: 2px;
            background-color: #dadada;
            cursor: pointer;
        }
        .music__volumnbar {
            position: absolute;
            top: 0;
            left: 0;
            width: 30px;
            height: 2px;
            background-color: rgb(155, 155, 155);
        }
        .music__player {
            float: left;
            width: 560px;
            padding: 0 20px;
        }
        .music__album {
            float: left;
            width: 240px;
            height: 240px;
            border-radius: 120px;
            overflow: hidden;
        }
        .music__img {
            width: 100%;
            height: 100%;
        }
        .musics__item {
            padding: 10px 20px;
            margin-bottom: 10px;
            background-color: #fff;
            cursor: pointer;
        }
        .player__progress {
            position: relative;
            width: 100%;
            height: 1px;
            margin: 10px 0 40px 0;
            background-color: #dadada;
        }
        .player__progressbar {
            position: absolute;
            left: 0;
            top: 0;
            height: 1px;
            background-color: rgb(107, 189, 122);
        }
        .player__play {
            margin-left: 8px;
            margin-right: 20px;
        }
        .player__play > .fa-play, .player__play > .fa-pause {
            font-size: 28px;
            cursor: pointer;
        }
        .player__faster {
            margin-right: 20px;
        }
        .player__faster > .fa-forward {
            font-size: 26px;
            cursor: pointer;
        }
        .player__next > .fa-step-forward {
            font-size: 26px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="music">
            <div class="music__player">
                <h2 class="music__title">${music.songname}</h2>
                <p class="music__singer">${singer}</p>
                <audio class="player__source">
                    Your browser does not support the <code>audio</code> element.
                    <source src="${music.audiourl}">
                </audio>
                <span class="music__currenttime">00:00/00:00</span>
                <i class="fa fa-volume-up music__volumnicon" aria-hidden="true"></i>
                <div class="music__volumn"><span class="music__volumnbar"></span></div>
                <div class="player__progress"><span class="player__progressbar"></span></div>
                <span class="player__play"><i class="fa fa-play" aria-hidden="true"></i></span>
                <span class="player__faster"><i class="fa fa-forward" aria-hidden="true"></i></span>
                <span class="player__next"><i class="fa fa-step-forward" aria-hidden="true"></i></span>
            </div>
            <div class="music__album">
                <img class="music__img" src="https://y.gtimg.cn/music/photo_new/T002R300x300M000${music.albummid}.jpg?max_age=2592000">
            </div>
        </div>
        <ul class="musics"></ul>
    </div>
    <script type="text/javascript" src="./lib/jquery.min.js"></script>
    <script type="text/javascript">
        function init () {
            // 初始化音乐列表
            searchMusic('河图')
                .then(res => {
                    // 渲染搜索结果列表
                    renderResult(res)
                    // 默认显示第一首
                    let number = 0
                    const title = document.querySelector('.music__title')
                    const singerEl = document.querySelector('.music__singer')
                    const time = document.querySelector('.music__currenttime')
                    // 初始化播放器控制器
                    const player = document.querySelector('.player__source')
                    const album = document.querySelector('.music__img')
                    render(res[number], title, singerEl, time, player, album)
                    // console.dir(player)
                    // 播放暂停按钮
                    let startBtn = document.querySelector('.player__play')
                    startBtn.onclick = function () {
                        // 如果当前是暂停
                        if (player.paused) {
                            play(startBtn, player, 'play')
                            return
                        }
                        play(startBtn, player, 'pause')
                    }
                    // 总时长
                    let duration = 0
                    player.addEventListener('canplay', function (e) {
                        duration = e.target.duration
                    })
                    // 进度控制
                    const currentTime = document.querySelector('.music__currenttime')
                    const progressBar = document.querySelector('.player__progressbar')
                    // player.addEventListener('timeupdate', function (e) {
                    //     let current = e.target.currentTime
                    //     currentTime.innerHTML = formatSeconds(current) + '/' + formatSeconds(duration)
                    //     // 计算播放百分比
                    //     // console.log(typeof current, typeof duration, current, duration, current / duration)
                    //     let per = current / duration * 100 + '%'
                    //     // console.log(per)
                    //     progressBar.style.right = `calc(100% - ${per})`
                    // })
                    setInterval(() => {
                        if (player.paused) {
                            return
                        }
                        let current = player.currentTime
                        currentTime.innerHTML = formatSeconds(current) + '/' + formatSeconds(duration)
                        // 计算播放百分比
                        // console.log(typeof current, typeof duration, current, duration, current / duration)
                        let per = current / duration * 100 + '%'
                        // console.log(per)
                        progressBar.style.right = `calc(100% - ${per})`
                    })
                    // 监听播放结束
                    player.addEventListener('ended', (e) => {
                        // 播放下一首
                        number += 1
                        next(res, number, title, singerEl, time, player, album, startBtn)
                        // render(res[number])
                        // // 要重新获取到 player 和 startBtn
                        // let player = document.querySelector('.player__source')
                        // let startBtn = document.querySelector('.player__play')
                        // play(startBtn, player, 'play')
                    })
                    // 快进
                    document.querySelector('.player__faster').onclick = function () {
                        player.currentTime += 5
                    }
                    // 音频控制
                    document.querySelector('.music__volumn').onclick = function (e) {
                        console.log(e, e.layerX)
                        // 将点击时的位置除以总长度，得到大概百分比
                        let width = e.target.clientWidth
                        const volumn = (e.layerX / width).toFixed(1)
                        console.log(volumn)
                    }
                    // 播放下一首
                    document.querySelector('.player__next').onclick = function () {
                        number += 1
                        next(res, number, title, singerEl, time, player, album, startBtn)
                    }
                })
                .catch(err => {
                    alert(err)
                })
        }
        /* 使用 qq 音乐接口搜索音乐列表
         * @param <String> query
         * @return <Promise>
         */
        function searchMusic (query, page=1) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: `https://c.y.qq.com/soso/fcgi-bin/client_search_cp?ct=24&qqmusic_ver=1298&remoteplace=sizer.yqq.song_next&searchid=151342943803015700&t=0&aggr=1&cr=1&catZhida=1&lossless=0&flag_qc=0&p=${page}&n=20&w=${query}&g_tk=755250217&loginUin=184009428&hostUin=0&format=jsonp&inCharset=utf8&outCharset=utf-8&notice=0&platform=yqq&needNewCode=0`,
                    type: 'GET',
                    dataType: 'jsonp',
                    jsonp: 'callback',
                    jsonpCallback: 'callback',
                    success (res) {
                        let list = res.data.song.list.map(music => {
                            return Object.assign(music, {
                                audiourl: `http://ws.stream.qqmusic.qq.com/${music.songid}.m4a?fromtag=46`
                            })
                        })
                        resolve(list)
                    },
                    error (err) {
                        reject(err)
                    }
                })
            })
        }
        /* 根据 json 渲染播放器
         * @param <Object> music
         */
        function render (music, title, singerEl, time, player, album) {
            const singer = music.singer.map(singer => {
                return singer.name
            }).join(', ')

            // 拿到对应的节点更新值
            // const title = document.querySelector('.music__title')
            title.innerText = music.songname
            // const singerEl = document.querySelector('.music__singer')
            singerEl.innerText = singer
            // const time = document.querySelector('.music__currenttime')
            time.innerText = '00:00/00:00'
            // const player = document.querySelector('.player__source')
            player.src = music.audiourl
            // const album = document.querySelector('.music__img')
            album.src = `https://y.gtimg.cn/music/photo_new/T002R300x300M000${music.albummid}.jpg?max_age=2592000`
            // let innerHtml = `<div class="music__player"><h2 class="music__title">${music.songname}</h2>
            // <p class="music__singer">${singer}</p>
            // <audio class="player__source">
            //     Your browser does not support the <code>audio</code> element.
            //     <source src="${music.audiourl}">
            // </audio><span class="music__currenttime"></span><i class="fa fa-volume-up music__volumnicon" aria-hidden="true"></i><div class="music__volumn"><span class="music__volumnbar"></span></div><div class="player__progress"><span class="player__progressbar"></span></div><span class="player__play"><i class="fa fa-play" aria-hidden="true"></i></span><span class="player__faster"><i class="fa fa-fast-forward" aria-hidden="true"></i></span></div><div class="music__album"><img class="music__img" src=""></div>`
            // document.querySelector('.music').innerHTML = innerHtml
        }
        /* 渲染搜索结果列表
         * @param <Array> ary
         */
        function renderResult (ary) {
            let container = document.createDocumentFragment()
            ary.forEach(music => {
                let li = document.createElement('li')
                li.className = 'musics__item'
                li.innerHTML = `<p>${music.songname}</p>`
                container.appendChild(li)
            })
            document.querySelector('.musics').appendChild(container)
        }
        /* 将秒数转换为时分秒
         * @param <Number>
         * @return <String>
         */
        function formatSeconds (value) {
            let second = parseInt(value)
            let hour = 0
            let minute = 0

            if (second >= 60) {
                minute = parseInt(second / 60)
                second = parseInt(second % 60)

                if (minute >= 60) {
                    hour = parseInt(minute / 60)
                    minute = parseInt(minute % 60)
                }
            }

            let result = second < 10 ? `0${second}` : second
            if (minute > 0) {
                result = (minute < 10 ? `0${minute}` : minute) + ':' + result
            } else {
                result = `00:${result}`
            }
            if (hour > 0) {
                result = (hour < 10 ? `0${hour}` : hour) + ':' + result
            }

            return result
        }
        /* 播放或者暂停音乐
         * @param <Element> btn
         * @param <Element> player
         * @param <String> type <play | pause>
         */
        function play (btn, player, type) {
            if (type === 'play') {
                player.play()
                // 并将图片更换为暂停
                btn.querySelector('.fa').className = 'fa fa-pause'
            } else if (type === 'pause') {
                player.pause()
                btn.querySelector('.fa').className = 'fa fa-play'
            }
        }
        /* 播放下一首
         */
        function next (list, current, title, singerEl, time, player, album, btn) {
            render(list[current], title, singerEl, time, player, album)
            play(btn, player, 'play')
        }

        window.onload = function () {
            init()
        }
    </script>
</body>
</html>