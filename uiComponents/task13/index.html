<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"> 
    <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>仿豆瓣音乐播放器</title>
    <style type="text/css">
        * {
            box-sizing: border-box;
        }
        body {
            background-color: rgba(250, 250, 250, 0.933333);
        }
        body, ul, div, p, h1, h2, h3 {
            margin: 0;
            padding: 0;
        }
        li {
            list-style: none;
        }
        .musics__item {
            padding: 10px 20px;
            margin-bottom: 10px;
            background-color: #fff;
            cursor: pointer;
        }
        .player__progress {
            position: relative;
            width: 100%;
            height: 1px;
            margin: 10px 0;
            background-color: #dadada;
        }
        .player__progressbar {
            position: absolute;
            left: 0;
            top: 0;
            height: 1px;
            background-color: rgb(107, 189, 122);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="music"></div>
        <ul class="musics"></ul>
    </div>
    <script type="text/javascript" src="./node_modules/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript">
        function init () {
            // 初始化音乐列表
            searchMusic('河图')
                .then(res => {
                    // 渲染搜索结果列表
                    renderResult(res)
                    // 默认显示第一首
                    render(res[0])
                    // 初始化播放器控制器
                    const player = document.querySelector('.player__source')
                    console.dir(player)
                    document.querySelector('.player__play').onclick = function () {
                        console.log('暂停')
                        if (player.paused) {
                            player.play()
                            return
                        }
                        player.pause()
                    }
                    // 进度控制
                    const currentTime = document.querySelector('.music__currenttime')
                    const progressBar = document.querySelector('.player__progressbar')
                    player.addEventListener('timeupdate', function (e) {
                        let current = e.target.currentTime
                        currentTime.innerHTML = current
                        // 计算播放百分比
                        // 总时长
                        const duration = player.duration
                        console.log(typeof current, typeof duration, current, duration, current / duration)
                        let per = current / duration * 100 + '%'
                        console.log(per)
                        progressBar.style.right = `calc(100% - ${per})`
                    })
                })
                .catch(err => {
                    alert(err)
                })
        }
        /* 使用 qq 音乐接口搜索音乐列表
         * @param <String> query
         * @return <Promise>
         */
        function searchMusic (query, page=1) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: `https://c.y.qq.com/soso/fcgi-bin/client_search_cp?ct=24&qqmusic_ver=1298&remoteplace=sizer.yqq.song_next&searchid=151342943803015700&t=0&aggr=1&cr=1&catZhida=1&lossless=0&flag_qc=0&p=${page}&n=20&w=${query}&g_tk=755250217&loginUin=184009428&hostUin=0&format=jsonp&inCharset=utf8&outCharset=utf-8&notice=0&platform=yqq&needNewCode=0`,
                    type: 'GET',
                    dataType: 'jsonp',
                    jsonp: 'callback',
                    jsonpCallback: 'callback',
                    success (res) {
                        let list = res.data.song.list.map(music => {
                            return Object.assign(music, {
                                audiourl: `http://ws.stream.qqmusic.qq.com/${music.songid}.m4a?fromtag=46`
                            })
                        })
                        resolve(list)
                    },
                    error (err) {
                        reject(err)
                    }
                })
            })
        }
        /* 根据 json 渲染播放器
         * @param <Object> music
         */
        function render (music) {
            const singer = music.singer.map(singer => {
                return singer.name
            }).join(', ')
            let innerHtml = `<div class="music_player"><h2 class="music__title">${music.songname}</h2>
            <p class="music__singer">${singer}</p>
            <audio class="player__source">
                Your browser does not support the <code>audio</code> element.
                <source src="${music.audiourl}">
            </audio><span class="music__currenttime">00:00</span><div class="player__progress"><span class="player__progressbar"></span></div><button class="player__play">暂停</button></div><div class="music__album"><img src="https://y.gtimg.cn/music/photo_new/T002R300x300M000${music.albummid}.jpg?max_age=2592000"></div>`
            document.querySelector('.music').innerHTML = innerHtml
        }
        /* 渲染搜索结果列表
         * @param <Array> ary
         */
        function renderResult (ary) {
            let container = document.createDocumentFragment()
            ary.forEach(music => {
                let li = document.createElement('li')
                li.className = 'musics__item'
                li.innerHTML = `<p>${music.songname}</p>`
                container.appendChild(li)
            })
            document.querySelector('.musics').appendChild(container)
        }

        window.onload = function () {
            init()
        }
    </script>
</body>
</html>